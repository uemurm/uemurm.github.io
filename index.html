<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>字幕音声同期プレイヤー</title>
<style>
  :root { --font-size: 20px; }

  body {
    font-family: sans-serif;
    line-height: 1.8;
    font-size: var(--font-size);
    margin-bottom: 80px; /* プレーヤー高さ分 */
  }

  #transcript span {
    opacity: 0.4;
    transition: opacity 0.2s ease, font-weight 0.2s ease;
  }

  #transcript span.active {
    opacity: 1;
    font-weight: bold;
  }

  /* プレーヤー固定 */
  .player-container {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100vw;
    background: #222;
    padding: 5px 10px;
    z-index: 9999;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
  }

  audio {
    width: 99%;
    height: 40px;
    outline: none;
  }

  .controls {
    margin-top: 5px;
    text-align: center;
  }

  button {
    margin: 2px 5px;
    padding: 4px 10px;
    font-size: 14px;
  }

  .file-inputs {
    margin-bottom: 10px;
  }
</style>
</head>
<body>

<h1>字幕音声同期プレイヤー</h1>

<div class="subtitle-input">
  <label for="jsonFile" accesskey="s">
    字幕ファイル (Alt+S): 
    <input type="file" id="jsonFile" accept=".json">
  </label>
</div>

<div class="audio-input">
  <label for="audioFile" accesskey="a">
    音声ファイル (Alt+A): 
    <input type="file" id="audioFile" accept="audio/*">
  </label>
</div>

<div id="transcript"></div>

<div class="player-container">
  <audio id="player" controls></audio>
  <div class="controls">
    <button id="back10">⏪ 10秒戻る</button>
    <button id="back5">⏪ 5秒戻る</button>
    <button id="forward5">5秒進む ⏩</button>
    <button id="forward10">10秒進む ⏩</button>
  </div>
</div>

<script>
const player = document.getElementById('player');
const audioInput = document.getElementById('audioFile');
const jsonInput = document.getElementById('jsonFile');
const transcriptContainer = document.getElementById('transcript');
let spans = [];

// 汎用シーク関数
function seek(delta) {
  const requested = player.currentTime + delta;
  player.currentTime = Math.min(player.duration || requested, Math.max(0, requested));
}

// 音声ファイル読み込み
audioInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  player.src = URL.createObjectURL(file);
  player.play();
});

// JSON ファイル読み込み
jsonInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    const segments = JSON.parse(reader.result);
    transcriptContainer.innerHTML = '';
    spans = [];

    segments.forEach(seg => {
      const span = document.createElement('span');
      span.textContent = seg.text + " ";
      span.dataset.start = seg.start;
      span.dataset.end = seg.end;
      transcriptContainer.appendChild(span);
      spans.push(span);
    });
  };
  reader.readAsText(file);
});

// ハイライト同期 + 自動スクロール
player.addEventListener('timeupdate', () => {
  const current = player.currentTime;
  spans.forEach(span => {
    const start = parseFloat(span.dataset.start);
    const end = parseFloat(span.dataset.end);
    const isActive = current >= start && current < end;
    span.classList.toggle('active', isActive);

    if (isActive) {
      // 中央にスクロール（画面中央に配置）
      const rect = span.getBoundingClientRect();
      const viewportHeight = window.innerHeight;
      const offset = rect.top - viewportHeight/2 + rect.height/2;
      window.scrollBy({ top: offset, behavior: 'smooth' });
    }
  });
});

// ボタンイベント
document.getElementById('back10').addEventListener('click', () => seek(-10));
document.getElementById('back5').addEventListener('click', () => seek(-5));
document.getElementById('forward5').addEventListener('click', () => seek(+5));
document.getElementById('forward10').addEventListener('click', () => seek(+10));

// ホットキー
document.addEventListener('keydown', e => {
  if (e.key === ' ' || e.key === 'k') {
    e.preventDefault();
    if(player.paused) player.play();
    else player.pause();
  }
  if(e.key === 'j') seek(-10);
  if(e.key === 'l') seek(+10);
  if(e.key === 'ArrowLeft') seek(-5);
  if(e.key === 'ArrowRight') seek(+5);
});
</script>

</body>
</html>
